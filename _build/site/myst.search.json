{"version":"1","records":[{"hierarchy":{"lvl1":"Ocean-CDR-Atlas-Calcs"},"type":"lvl1","url":"/","position":0},{"hierarchy":{"lvl1":"Ocean-CDR-Atlas-Calcs"},"content":"","type":"content","url":"/","position":1},{"hierarchy":{"lvl1":"CCS 12km"},"type":"lvl1","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12","position":0},{"hierarchy":{"lvl1":"CCS 12km"},"content":"","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12","position":1},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Mapping the Extent of mCDR Signals within Finite Regional Domains"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#mapping-the-extent-of-mcdr-signals-within-finite-regional-domains","position":2},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Mapping the Extent of mCDR Signals within Finite Regional Domains"},"content":"This notebook demonstrates how to map the extent of marine Carbon Dioxide Removal (mCDR) signals within finite regional domains. The analysis involves:\n\nDefining the regional model grid: Creating a finite regional ocean model grid using ROMS tools\n\nLoading the global atlas grid: Using the POP ocean model grid as the base for the atlas dataset\n\nIdentifying overlapping polygons: Finding which atlas polygons intersect with the regional domain\n\nIntegrating CO2 fluxes: Computing cumulative CO2 uptake within the regional domain boundaries\n\nVisualizing results: Mapping the fraction of CO2 uptake captured within the regional domain\n\nThe key challenge is determining what fraction of the global mCDR signal (from the atlas) is captured within a finite regional model domain, which is essential for understanding the efficiency and spatial extent of regional mCDR deployments.\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#mapping-the-extent-of-mcdr-signals-within-finite-regional-domains","position":3},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 1: Import Required Libraries"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-1-import-required-libraries","position":4},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 1: Import Required Libraries"},"content":"Load the necessary Python packages for data manipulation, grid handling, and analysis utilities.\n\n%load_ext autoreload\n%autoreload 2\n\nimport numpy as np\nimport xarray as xr\n\nimport roms_tools as rt\n\nimport cdr_atlas\nimport parsers\nimport utils\n\n\n\ngrid_yaml = \"tests/_grid.yml\"\ntest = True\ndask_cluster_kwargs = {\n    \"account\": \"m4632\",\n    \"queue_name\": \"premium\",\n    \"scheduler_file\": None,\n}\n\n\n\n# Parameters\ndomain_name = \"CCS 12km\"\ngrid_yaml = \"cson_forge/blueprints/cson_roms-marbl_v0.1_ccs-12km/_grid.yml\"\ntest = True\ndask_cluster_kwargs = {\n    \"account\": \"m4632\",\n    \"queue_name\": \"premium\",\n    \"n_nodes\": 1,\n    \"n_tasks_per_node\": 128,\n    \"wallclock\": \"02:00:00\",\n    \"scheduler_file\": None,\n}\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-1-import-required-libraries","position":5},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 2: Define the Regional Model Grid"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-2-define-the-regional-model-grid","position":6},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 2: Define the Regional Model Grid"},"content":"Create a finite regional ocean model grid using ROMS (Regional Ocean Modeling System) tools. This grid defines the spatial boundaries of our regional domain. The grid parameters include:\n\nGrid dimensions: number of grid points\n\nPhysical size: domain extent\n\nCenter location: geographic center\n\nRotation: grid rotation angle\n\nVertical levels: number of vertical sigma levels\n\nThe grid is plotted to visualize the regional domain extent.\n\nmodel_grid = parsers.load_roms_tools_object(grid_yaml)\nmodel_grid.plot()\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-2-define-the-regional-model-grid","position":7},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 2: Load the Global Atlas Grid"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-2-load-the-global-atlas-grid","position":8},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 2: Load the Global Atlas Grid"},"content":"Load the POP (Parallel Ocean Program) global ocean model grid (POP_gx1v7), which serves as the base grid for the atlas dataset. This grid provides the spatial coordinates (TLAT, TLONG) and cell areas (TAREA) needed for area-weighted calculations.\n\natlas_grid = cdr_atlas.get_pop_grid()\natlas_grid\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-2-load-the-global-atlas-grid","position":9},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 4: Load Polygon Masks"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-4-load-polygon-masks","position":10},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 4: Load Polygon Masks"},"content":"Load the polygon masks from the atlas dataset. Each polygon represents a distinct mCDR injection location. The polygon IDs are masked to only include ocean points (where KMT > 0, indicating valid ocean grid cells).\n\nds_atlas_polygons = cdr_atlas.get_polygon_masks_dataset()\npolygon_ids = ds_atlas_polygons.polygon_id.where(atlas_grid.KMT > 0)\npolygon_ids.plot()\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-4-load-polygon-masks","position":11},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 5: Create Analyzer and Identify Overlapping Polygons"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-5-create-analyzer-and-identify-overlapping-polygons","position":12},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 5: Create Analyzer and Identify Overlapping Polygons"},"content":"Initialize the AtlasModelGridAnalyzer class, which:\n\nComputes the convex hull of the regional model grid using all lat/lon points from model_grid.ds.lat_u and lon_u\n\nPerforms point-in-polygon tests to identify which atlas grid points fall within the regional domain boundaries\n\nExtracts unique polygon IDs that have at least some overlap with the regional domain\n\nCreates a polygon ID mask where polygon IDs are set to -1 outside the regional domain\n\nThe analyzer uses a convex hull approach (rather than a simple bounding box) to accurately handle non-rectangular regional domains. The resulting mask shows which polygons intersect with the regional domain.p\n\n# Create AtlasModelGridAnalyzer instance\nanalyzer = cdr_atlas.AtlasModelGridAnalyzer(model_grid, atlas_grid, polygon_ids=polygon_ids)\n\n# Get polygon IDs within model grid boundaries\nprint(f\"Found {len(analyzer.polygon_ids_in_bounds)} unique polygon IDs within model grid boundaries\")\nprint(f\"Polygon IDs: {analyzer.polygon_ids_in_bounds[:100]}...\" if len(analyzer.polygon_ids_in_bounds) > 100 else f\"Polygon IDs: {analyzer.polygon_ids_in_bounds}\")\n\nanalyzer.polygon_id_mask.plot(vmin=-1, vmax=analyzer.polygon_id_mask.max())\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-5-create-analyzer-and-identify-overlapping-polygons","position":13},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 6: Test: Integrate CO2 Flux for a Single Polygon"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-6-test-integrate-co2-flux-for-a-single-polygon","position":14},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 6: Test: Integrate CO2 Flux for a Single Polygon"},"content":"Compute the cumulative CO2 uptake for a single polygon over a 3-month period. The integration:\n\nRetrieves alk-forcing files from S3 (with local caching) for the specified polygon, injection date, and time period\n\nCalculates the additional CO2 flux (FG_CO2_additional = FG_CO2 - FG_ALT_CO2) which represents the mCDR signal\n\nIntegrates over space and time using:\n\nArea weighting with TAREA (grid cell areas)\n\nTime weighting with days per month converted to seconds\n\nSpatial masking to restrict to points within the regional domain\n\nComputes cumulative integrals over the elapsed time dimension\n\nThe results show:\n\nTotal integrated FG_CO2: Total CO2 uptake over the entire polygon extent\n\nWithin model grid: CO2 uptake within the regional domain boundaries\n\nFraction within grid: Percentage of total uptake captured by the regional domain\n\nyears = [347+i for i in range(15)]\nyears\n\n\n\ncluster = utils.dask_cluster(**dask_cluster_kwargs)\ncluster\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n%%time\n# Integrate FG_CO2 for polygon 000 over 3 months\n# Using the alk-forcing files: 0347-01, 0347-02, 0347-03\nresults = analyzer.integrate_fg_co2_polygon(\n    polygon_id=analyzer.polygon_ids_in_bounds[-1],\n    years=years[-2:-1],\n    months=[1, 2, 3],\n)\n\nprint(\"FG_CO2 Integration Results:\")\nprint(f\"  Total integrated FG_CO2: {results['total'].values[-1]:.2e}\")\nprint(f\"  Within model grid: {results['within_grid'].values[-1]:.2e}\")\nprint(f\"  Fraction within grid: {results['fraction'].values[-1]:.2%}\")\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-6-test-integrate-co2-flux-for-a-single-polygon","position":15},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 7: Integrate CO2 Flux for All Overlapping Polygons"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-7-integrate-co2-flux-for-all-overlapping-polygons","position":16},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 7: Integrate CO2 Flux for All Overlapping Polygons"},"content":"Compute the cumulative CO2 uptake for all polygons that intersect with the regional domain. This provides a comprehensive view of how much of the global mCDR signal is captured within the finite regional domain. The results are concatenated along the polygon_id dimension, creating a dataset with dimensions (polygon_id, elapsed_time).\n\n%%time\nds = None\nif not test:\n    ds = analyzer.integrate_fg_co2_all_polygons(\n        years=years,\n    )   \nds\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-7-integrate-co2-flux-for-all-overlapping-polygons","position":17},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 8: Visualize Fraction of Uptake within Regional Domain"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-8-visualize-fraction-of-uptake-within-regional-domain","position":18},{"hierarchy":{"lvl1":"CCS 12km","lvl2":"Step 8: Visualize Fraction of Uptake within Regional Domain"},"content":"Map the fraction of CO2 uptake captured within the regional domain for each polygon. The visualization shows:\n\nRed regions: Polygons where a large fraction of CO2 uptake occurs within the regional domain\n\nBlue regions: Polygons where most CO2 uptake occurs outside the regional domain\n\nThis spatial map helps identify which mCDR injection locations are most effectively captured by the regional model domain, which is critical for understanding the efficiency of regional mCDR monitoring and modeling efforts.\n\nif ds is not None:\n    analyzer.set_field_within_boundaries(ds.fraction.isel(elapsed_time=-1)).plot(cmap=\"RdBu_r\")\n\n\n\n\n# check if LocalCluster is running and shutdown\nif cluster.local_cluster:\n    cluster.shutdown()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-ccs-12#step-8-visualize-fraction-of-uptake-within-regional-domain","position":19},{"hierarchy":{"lvl1":"Gulf Guinea Toy"},"type":"lvl1","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g","position":0},{"hierarchy":{"lvl1":"Gulf Guinea Toy"},"content":"","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g","position":1},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Mapping the Extent of mCDR Signals within Finite Regional Domains"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#mapping-the-extent-of-mcdr-signals-within-finite-regional-domains","position":2},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Mapping the Extent of mCDR Signals within Finite Regional Domains"},"content":"This notebook demonstrates how to map the extent of marine Carbon Dioxide Removal (mCDR) signals within finite regional domains. The analysis involves:\n\nDefining the regional model grid: Creating a finite regional ocean model grid using ROMS tools\n\nLoading the global atlas grid: Using the POP ocean model grid as the base for the atlas dataset\n\nIdentifying overlapping polygons: Finding which atlas polygons intersect with the regional domain\n\nIntegrating CO2 fluxes: Computing cumulative CO2 uptake within the regional domain boundaries\n\nVisualizing results: Mapping the fraction of CO2 uptake captured within the regional domain\n\nThe key challenge is determining what fraction of the global mCDR signal (from the atlas) is captured within a finite regional model domain, which is essential for understanding the efficiency and spatial extent of regional mCDR deployments.\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#mapping-the-extent-of-mcdr-signals-within-finite-regional-domains","position":3},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 1: Import Required Libraries"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-1-import-required-libraries","position":4},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 1: Import Required Libraries"},"content":"Load the necessary Python packages for data manipulation, grid handling, and analysis utilities.\n\n%load_ext autoreload\n%autoreload 2\n\nimport numpy as np\nimport xarray as xr\n\nimport roms_tools as rt\n\nimport cdr_atlas\nimport parsers\nimport utils\n\n\n\ngrid_yaml = \"tests/_grid.yml\"\ntest = True\ndask_cluster_kwargs = {\n    \"account\": \"m4632\",\n    \"queue_name\": \"premium\",\n    \"scheduler_file\": None,\n}\n\n\n\n# Parameters\ndomain_name = \"Gulf Guinea Toy\"\ngrid_yaml = \"cson_forge/blueprints/cson_roms-marbl_v0.1_gulf-guinea-toy/_grid.yml\"\ntest = True\ndask_cluster_kwargs = {\n    \"account\": \"m4632\",\n    \"queue_name\": \"premium\",\n    \"n_nodes\": 1,\n    \"n_tasks_per_node\": 128,\n    \"wallclock\": \"02:00:00\",\n    \"scheduler_file\": None,\n}\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-1-import-required-libraries","position":5},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 2: Define the Regional Model Grid"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-2-define-the-regional-model-grid","position":6},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 2: Define the Regional Model Grid"},"content":"Create a finite regional ocean model grid using ROMS (Regional Ocean Modeling System) tools. This grid defines the spatial boundaries of our regional domain. The grid parameters include:\n\nGrid dimensions: number of grid points\n\nPhysical size: domain extent\n\nCenter location: geographic center\n\nRotation: grid rotation angle\n\nVertical levels: number of vertical sigma levels\n\nThe grid is plotted to visualize the regional domain extent.\n\nmodel_grid = parsers.load_roms_tools_object(grid_yaml)\nmodel_grid.plot()\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-2-define-the-regional-model-grid","position":7},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 2: Load the Global Atlas Grid"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-2-load-the-global-atlas-grid","position":8},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 2: Load the Global Atlas Grid"},"content":"Load the POP (Parallel Ocean Program) global ocean model grid (POP_gx1v7), which serves as the base grid for the atlas dataset. This grid provides the spatial coordinates (TLAT, TLONG) and cell areas (TAREA) needed for area-weighted calculations.\n\natlas_grid = cdr_atlas.get_pop_grid()\natlas_grid\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-2-load-the-global-atlas-grid","position":9},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 4: Load Polygon Masks"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-4-load-polygon-masks","position":10},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 4: Load Polygon Masks"},"content":"Load the polygon masks from the atlas dataset. Each polygon represents a distinct mCDR injection location. The polygon IDs are masked to only include ocean points (where KMT > 0, indicating valid ocean grid cells).\n\nds_atlas_polygons = cdr_atlas.get_polygon_masks_dataset()\npolygon_ids = ds_atlas_polygons.polygon_id.where(atlas_grid.KMT > 0)\npolygon_ids.plot()\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-4-load-polygon-masks","position":11},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 5: Create Analyzer and Identify Overlapping Polygons"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-5-create-analyzer-and-identify-overlapping-polygons","position":12},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 5: Create Analyzer and Identify Overlapping Polygons"},"content":"Initialize the AtlasModelGridAnalyzer class, which:\n\nComputes the convex hull of the regional model grid using all lat/lon points from model_grid.ds.lat_u and lon_u\n\nPerforms point-in-polygon tests to identify which atlas grid points fall within the regional domain boundaries\n\nExtracts unique polygon IDs that have at least some overlap with the regional domain\n\nCreates a polygon ID mask where polygon IDs are set to -1 outside the regional domain\n\nThe analyzer uses a convex hull approach (rather than a simple bounding box) to accurately handle non-rectangular regional domains. The resulting mask shows which polygons intersect with the regional domain.p\n\n# Create AtlasModelGridAnalyzer instance\nanalyzer = cdr_atlas.AtlasModelGridAnalyzer(model_grid, atlas_grid, polygon_ids=polygon_ids)\n\n# Get polygon IDs within model grid boundaries\nprint(f\"Found {len(analyzer.polygon_ids_in_bounds)} unique polygon IDs within model grid boundaries\")\nprint(f\"Polygon IDs: {analyzer.polygon_ids_in_bounds[:100]}...\" if len(analyzer.polygon_ids_in_bounds) > 100 else f\"Polygon IDs: {analyzer.polygon_ids_in_bounds}\")\n\nanalyzer.polygon_id_mask.plot(vmin=-1, vmax=analyzer.polygon_id_mask.max())\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-5-create-analyzer-and-identify-overlapping-polygons","position":13},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 6: Test: Integrate CO2 Flux for a Single Polygon"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-6-test-integrate-co2-flux-for-a-single-polygon","position":14},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 6: Test: Integrate CO2 Flux for a Single Polygon"},"content":"Compute the cumulative CO2 uptake for a single polygon over a 3-month period. The integration:\n\nRetrieves alk-forcing files from S3 (with local caching) for the specified polygon, injection date, and time period\n\nCalculates the additional CO2 flux (FG_CO2_additional = FG_CO2 - FG_ALT_CO2) which represents the mCDR signal\n\nIntegrates over space and time using:\n\nArea weighting with TAREA (grid cell areas)\n\nTime weighting with days per month converted to seconds\n\nSpatial masking to restrict to points within the regional domain\n\nComputes cumulative integrals over the elapsed time dimension\n\nThe results show:\n\nTotal integrated FG_CO2: Total CO2 uptake over the entire polygon extent\n\nWithin model grid: CO2 uptake within the regional domain boundaries\n\nFraction within grid: Percentage of total uptake captured by the regional domain\n\nyears = [347+i for i in range(15)]\nyears\n\n\n\ncluster = utils.dask_cluster(**dask_cluster_kwargs)\ncluster\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n%%time\n# Integrate FG_CO2 for polygon 000 over 3 months\n# Using the alk-forcing files: 0347-01, 0347-02, 0347-03\nresults = analyzer.integrate_fg_co2_polygon(\n    polygon_id=analyzer.polygon_ids_in_bounds[-1],\n    years=years[-2:-1],\n    months=[1, 2, 3],\n)\n\nprint(\"FG_CO2 Integration Results:\")\nprint(f\"  Total integrated FG_CO2: {results['total'].values[-1]:.2e}\")\nprint(f\"  Within model grid: {results['within_grid'].values[-1]:.2e}\")\nprint(f\"  Fraction within grid: {results['fraction'].values[-1]:.2%}\")\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-6-test-integrate-co2-flux-for-a-single-polygon","position":15},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 7: Integrate CO2 Flux for All Overlapping Polygons"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-7-integrate-co2-flux-for-all-overlapping-polygons","position":16},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 7: Integrate CO2 Flux for All Overlapping Polygons"},"content":"Compute the cumulative CO2 uptake for all polygons that intersect with the regional domain. This provides a comprehensive view of how much of the global mCDR signal is captured within the finite regional domain. The results are concatenated along the polygon_id dimension, creating a dataset with dimensions (polygon_id, elapsed_time).\n\n%%time\nds = None\nif not test:\n    ds = analyzer.integrate_fg_co2_all_polygons(\n        years=years,\n    )   \nds\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-7-integrate-co2-flux-for-all-overlapping-polygons","position":17},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 8: Visualize Fraction of Uptake within Regional Domain"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-8-visualize-fraction-of-uptake-within-regional-domain","position":18},{"hierarchy":{"lvl1":"Gulf Guinea Toy","lvl2":"Step 8: Visualize Fraction of Uptake within Regional Domain"},"content":"Map the fraction of CO2 uptake captured within the regional domain for each polygon. The visualization shows:\n\nRed regions: Polygons where a large fraction of CO2 uptake occurs within the regional domain\n\nBlue regions: Polygons where most CO2 uptake occurs outside the regional domain\n\nThis spatial map helps identify which mCDR injection locations are most effectively captured by the regional model domain, which is critical for understanding the efficiency of regional mCDR monitoring and modeling efforts.\n\nif ds is not None:\n    analyzer.set_field_within_boundaries(ds.fraction.isel(elapsed_time=-1)).plot(cmap=\"RdBu_r\")\n\n\n\n\n# check if LocalCluster is running and shutdown\nif cluster.local_cluster:\n    cluster.shutdown()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-gulf-g#step-8-visualize-fraction-of-uptake-within-regional-domain","position":19},{"hierarchy":{"lvl1":"Hvalfjörður 0"},"type":"lvl1","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj","position":0},{"hierarchy":{"lvl1":"Hvalfjörður 0"},"content":"","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj","position":1},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Mapping the Extent of mCDR Signals within Finite Regional Domains"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#mapping-the-extent-of-mcdr-signals-within-finite-regional-domains","position":2},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Mapping the Extent of mCDR Signals within Finite Regional Domains"},"content":"This notebook demonstrates how to map the extent of marine Carbon Dioxide Removal (mCDR) signals within finite regional domains. The analysis involves:\n\nDefining the regional model grid: Creating a finite regional ocean model grid using ROMS tools\n\nLoading the global atlas grid: Using the POP ocean model grid as the base for the atlas dataset\n\nIdentifying overlapping polygons: Finding which atlas polygons intersect with the regional domain\n\nIntegrating CO2 fluxes: Computing cumulative CO2 uptake within the regional domain boundaries\n\nVisualizing results: Mapping the fraction of CO2 uptake captured within the regional domain\n\nThe key challenge is determining what fraction of the global mCDR signal (from the atlas) is captured within a finite regional model domain, which is essential for understanding the efficiency and spatial extent of regional mCDR deployments.\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#mapping-the-extent-of-mcdr-signals-within-finite-regional-domains","position":3},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 1: Import Required Libraries"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-1-import-required-libraries","position":4},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 1: Import Required Libraries"},"content":"Load the necessary Python packages for data manipulation, grid handling, and analysis utilities.\n\n%load_ext autoreload\n%autoreload 2\n\nimport numpy as np\nimport xarray as xr\n\nimport roms_tools as rt\n\nimport cdr_atlas\nimport parsers\nimport utils\n\n\n\ngrid_yaml = \"tests/_grid.yml\"\ntest = True\ndask_cluster_kwargs = {\n    \"account\": \"m4632\",\n    \"queue_name\": \"premium\",\n    \"scheduler_file\": None,\n}\n\n\n\n# Parameters\ndomain_name = \"Hvalfj\\xf6r\\xf0ur 0\"\ngrid_yaml = \"cson_forge/blueprints/cson_roms-marbl_v0.1_hvalfj\\xf6r\\xf0ur-0/_grid.yml\"\ntest = True\ndask_cluster_kwargs = {\n    \"account\": \"m4632\",\n    \"queue_name\": \"premium\",\n    \"n_nodes\": 1,\n    \"n_tasks_per_node\": 128,\n    \"wallclock\": \"02:00:00\",\n    \"scheduler_file\": None,\n}\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-1-import-required-libraries","position":5},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 2: Define the Regional Model Grid"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-2-define-the-regional-model-grid","position":6},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 2: Define the Regional Model Grid"},"content":"Create a finite regional ocean model grid using ROMS (Regional Ocean Modeling System) tools. This grid defines the spatial boundaries of our regional domain. The grid parameters include:\n\nGrid dimensions: number of grid points\n\nPhysical size: domain extent\n\nCenter location: geographic center\n\nRotation: grid rotation angle\n\nVertical levels: number of vertical sigma levels\n\nThe grid is plotted to visualize the regional domain extent.\n\nmodel_grid = parsers.load_roms_tools_object(grid_yaml)\nmodel_grid.plot()\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-2-define-the-regional-model-grid","position":7},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 2: Load the Global Atlas Grid"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-2-load-the-global-atlas-grid","position":8},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 2: Load the Global Atlas Grid"},"content":"Load the POP (Parallel Ocean Program) global ocean model grid (POP_gx1v7), which serves as the base grid for the atlas dataset. This grid provides the spatial coordinates (TLAT, TLONG) and cell areas (TAREA) needed for area-weighted calculations.\n\natlas_grid = cdr_atlas.get_pop_grid()\natlas_grid\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-2-load-the-global-atlas-grid","position":9},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 4: Load Polygon Masks"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-4-load-polygon-masks","position":10},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 4: Load Polygon Masks"},"content":"Load the polygon masks from the atlas dataset. Each polygon represents a distinct mCDR injection location. The polygon IDs are masked to only include ocean points (where KMT > 0, indicating valid ocean grid cells).\n\nds_atlas_polygons = cdr_atlas.get_polygon_masks_dataset()\npolygon_ids = ds_atlas_polygons.polygon_id.where(atlas_grid.KMT > 0)\npolygon_ids.plot()\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-4-load-polygon-masks","position":11},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 5: Create Analyzer and Identify Overlapping Polygons"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-5-create-analyzer-and-identify-overlapping-polygons","position":12},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 5: Create Analyzer and Identify Overlapping Polygons"},"content":"Initialize the AtlasModelGridAnalyzer class, which:\n\nComputes the convex hull of the regional model grid using all lat/lon points from model_grid.ds.lat_u and lon_u\n\nPerforms point-in-polygon tests to identify which atlas grid points fall within the regional domain boundaries\n\nExtracts unique polygon IDs that have at least some overlap with the regional domain\n\nCreates a polygon ID mask where polygon IDs are set to -1 outside the regional domain\n\nThe analyzer uses a convex hull approach (rather than a simple bounding box) to accurately handle non-rectangular regional domains. The resulting mask shows which polygons intersect with the regional domain.p\n\n# Create AtlasModelGridAnalyzer instance\nanalyzer = cdr_atlas.AtlasModelGridAnalyzer(model_grid, atlas_grid, polygon_ids=polygon_ids)\n\n# Get polygon IDs within model grid boundaries\nprint(f\"Found {len(analyzer.polygon_ids_in_bounds)} unique polygon IDs within model grid boundaries\")\nprint(f\"Polygon IDs: {analyzer.polygon_ids_in_bounds[:100]}...\" if len(analyzer.polygon_ids_in_bounds) > 100 else f\"Polygon IDs: {analyzer.polygon_ids_in_bounds}\")\n\nanalyzer.polygon_id_mask.plot(vmin=-1, vmax=analyzer.polygon_id_mask.max())\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-5-create-analyzer-and-identify-overlapping-polygons","position":13},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 6: Test: Integrate CO2 Flux for a Single Polygon"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-6-test-integrate-co2-flux-for-a-single-polygon","position":14},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 6: Test: Integrate CO2 Flux for a Single Polygon"},"content":"Compute the cumulative CO2 uptake for a single polygon over a 3-month period. The integration:\n\nRetrieves alk-forcing files from S3 (with local caching) for the specified polygon, injection date, and time period\n\nCalculates the additional CO2 flux (FG_CO2_additional = FG_CO2 - FG_ALT_CO2) which represents the mCDR signal\n\nIntegrates over space and time using:\n\nArea weighting with TAREA (grid cell areas)\n\nTime weighting with days per month converted to seconds\n\nSpatial masking to restrict to points within the regional domain\n\nComputes cumulative integrals over the elapsed time dimension\n\nThe results show:\n\nTotal integrated FG_CO2: Total CO2 uptake over the entire polygon extent\n\nWithin model grid: CO2 uptake within the regional domain boundaries\n\nFraction within grid: Percentage of total uptake captured by the regional domain\n\nyears = [347+i for i in range(15)]\nyears\n\n\n\ncluster = utils.dask_cluster(**dask_cluster_kwargs)\ncluster\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n%%time\n# Integrate FG_CO2 for polygon 000 over 3 months\n# Using the alk-forcing files: 0347-01, 0347-02, 0347-03\nresults = analyzer.integrate_fg_co2_polygon(\n    polygon_id=analyzer.polygon_ids_in_bounds[-1],\n    years=years[-2:-1],\n    months=[1, 2, 3],\n)\n\nprint(\"FG_CO2 Integration Results:\")\nprint(f\"  Total integrated FG_CO2: {results['total'].values[-1]:.2e}\")\nprint(f\"  Within model grid: {results['within_grid'].values[-1]:.2e}\")\nprint(f\"  Fraction within grid: {results['fraction'].values[-1]:.2%}\")\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-6-test-integrate-co2-flux-for-a-single-polygon","position":15},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 7: Integrate CO2 Flux for All Overlapping Polygons"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-7-integrate-co2-flux-for-all-overlapping-polygons","position":16},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 7: Integrate CO2 Flux for All Overlapping Polygons"},"content":"Compute the cumulative CO2 uptake for all polygons that intersect with the regional domain. This provides a comprehensive view of how much of the global mCDR signal is captured within the finite regional domain. The results are concatenated along the polygon_id dimension, creating a dataset with dimensions (polygon_id, elapsed_time).\n\n%%time\nds = None\nif not test:\n    ds = analyzer.integrate_fg_co2_all_polygons(\n        years=years,\n    )   \nds\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-7-integrate-co2-flux-for-all-overlapping-polygons","position":17},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 8: Visualize Fraction of Uptake within Regional Domain"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-8-visualize-fraction-of-uptake-within-regional-domain","position":18},{"hierarchy":{"lvl1":"Hvalfjörður 0","lvl2":"Step 8: Visualize Fraction of Uptake within Regional Domain"},"content":"Map the fraction of CO2 uptake captured within the regional domain for each polygon. The visualization shows:\n\nRed regions: Polygons where a large fraction of CO2 uptake occurs within the regional domain\n\nBlue regions: Polygons where most CO2 uptake occurs outside the regional domain\n\nThis spatial map helps identify which mCDR injection locations are most effectively captured by the regional model domain, which is critical for understanding the efficiency of regional mCDR monitoring and modeling efforts.\n\nif ds is not None:\n    analyzer.set_field_within_boundaries(ds.fraction.isel(elapsed_time=-1)).plot(cmap=\"RdBu_r\")\n\n\n\n\n# check if LocalCluster is running and shutdown\nif cluster.local_cluster:\n    cluster.shutdown()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-hvalfj#step-8-visualize-fraction-of-uptake-within-regional-domain","position":19},{"hierarchy":{"lvl1":"Test Tiny"},"type":"lvl1","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t","position":0},{"hierarchy":{"lvl1":"Test Tiny"},"content":"","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t","position":1},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Mapping the Extent of mCDR Signals within Finite Regional Domains"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#mapping-the-extent-of-mcdr-signals-within-finite-regional-domains","position":2},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Mapping the Extent of mCDR Signals within Finite Regional Domains"},"content":"This notebook demonstrates how to map the extent of marine Carbon Dioxide Removal (mCDR) signals within finite regional domains. The analysis involves:\n\nDefining the regional model grid: Creating a finite regional ocean model grid using ROMS tools\n\nLoading the global atlas grid: Using the POP ocean model grid as the base for the atlas dataset\n\nIdentifying overlapping polygons: Finding which atlas polygons intersect with the regional domain\n\nIntegrating CO2 fluxes: Computing cumulative CO2 uptake within the regional domain boundaries\n\nVisualizing results: Mapping the fraction of CO2 uptake captured within the regional domain\n\nThe key challenge is determining what fraction of the global mCDR signal (from the atlas) is captured within a finite regional model domain, which is essential for understanding the efficiency and spatial extent of regional mCDR deployments.\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#mapping-the-extent-of-mcdr-signals-within-finite-regional-domains","position":3},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 1: Import Required Libraries"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-1-import-required-libraries","position":4},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 1: Import Required Libraries"},"content":"Load the necessary Python packages for data manipulation, grid handling, and analysis utilities.\n\n%load_ext autoreload\n%autoreload 2\n\nimport numpy as np\nimport xarray as xr\n\nimport roms_tools as rt\n\nimport cdr_atlas\nimport parsers\nimport utils\n\n\n\ngrid_yaml = \"tests/_grid.yml\"\ntest = True\ndask_cluster_kwargs = {\n    \"account\": \"m4632\",\n    \"queue_name\": \"premium\",\n    \"scheduler_file\": None,\n}\n\n\n\n# Parameters\ndomain_name = \"Test Tiny\"\ngrid_yaml = \"cson_forge/blueprints/cson_roms-marbl_v0.1_test-tiny/_grid.yml\"\ntest = True\ndask_cluster_kwargs = {\n    \"account\": \"m4632\",\n    \"queue_name\": \"premium\",\n    \"n_nodes\": 1,\n    \"n_tasks_per_node\": 128,\n    \"wallclock\": \"02:00:00\",\n    \"scheduler_file\": None,\n}\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-1-import-required-libraries","position":5},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 2: Define the Regional Model Grid"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-2-define-the-regional-model-grid","position":6},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 2: Define the Regional Model Grid"},"content":"Create a finite regional ocean model grid using ROMS (Regional Ocean Modeling System) tools. This grid defines the spatial boundaries of our regional domain. The grid parameters include:\n\nGrid dimensions: number of grid points\n\nPhysical size: domain extent\n\nCenter location: geographic center\n\nRotation: grid rotation angle\n\nVertical levels: number of vertical sigma levels\n\nThe grid is plotted to visualize the regional domain extent.\n\nmodel_grid = parsers.load_roms_tools_object(grid_yaml)\nmodel_grid.plot()\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-2-define-the-regional-model-grid","position":7},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 2: Load the Global Atlas Grid"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-2-load-the-global-atlas-grid","position":8},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 2: Load the Global Atlas Grid"},"content":"Load the POP (Parallel Ocean Program) global ocean model grid (POP_gx1v7), which serves as the base grid for the atlas dataset. This grid provides the spatial coordinates (TLAT, TLONG) and cell areas (TAREA) needed for area-weighted calculations.\n\natlas_grid = cdr_atlas.get_pop_grid()\natlas_grid\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-2-load-the-global-atlas-grid","position":9},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 4: Load Polygon Masks"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-4-load-polygon-masks","position":10},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 4: Load Polygon Masks"},"content":"Load the polygon masks from the atlas dataset. Each polygon represents a distinct mCDR injection location. The polygon IDs are masked to only include ocean points (where KMT > 0, indicating valid ocean grid cells).\n\nds_atlas_polygons = cdr_atlas.get_polygon_masks_dataset()\npolygon_ids = ds_atlas_polygons.polygon_id.where(atlas_grid.KMT > 0)\npolygon_ids.plot()\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-4-load-polygon-masks","position":11},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 5: Create Analyzer and Identify Overlapping Polygons"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-5-create-analyzer-and-identify-overlapping-polygons","position":12},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 5: Create Analyzer and Identify Overlapping Polygons"},"content":"Initialize the AtlasModelGridAnalyzer class, which:\n\nComputes the convex hull of the regional model grid using all lat/lon points from model_grid.ds.lat_u and lon_u\n\nPerforms point-in-polygon tests to identify which atlas grid points fall within the regional domain boundaries\n\nExtracts unique polygon IDs that have at least some overlap with the regional domain\n\nCreates a polygon ID mask where polygon IDs are set to -1 outside the regional domain\n\nThe analyzer uses a convex hull approach (rather than a simple bounding box) to accurately handle non-rectangular regional domains. The resulting mask shows which polygons intersect with the regional domain.p\n\n# Create AtlasModelGridAnalyzer instance\nanalyzer = cdr_atlas.AtlasModelGridAnalyzer(model_grid, atlas_grid, polygon_ids=polygon_ids)\n\n# Get polygon IDs within model grid boundaries\nprint(f\"Found {len(analyzer.polygon_ids_in_bounds)} unique polygon IDs within model grid boundaries\")\nprint(f\"Polygon IDs: {analyzer.polygon_ids_in_bounds[:100]}...\" if len(analyzer.polygon_ids_in_bounds) > 100 else f\"Polygon IDs: {analyzer.polygon_ids_in_bounds}\")\n\nanalyzer.polygon_id_mask.plot(vmin=-1, vmax=analyzer.polygon_id_mask.max())\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-5-create-analyzer-and-identify-overlapping-polygons","position":13},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 6: Test: Integrate CO2 Flux for a Single Polygon"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-6-test-integrate-co2-flux-for-a-single-polygon","position":14},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 6: Test: Integrate CO2 Flux for a Single Polygon"},"content":"Compute the cumulative CO2 uptake for a single polygon over a 3-month period. The integration:\n\nRetrieves alk-forcing files from S3 (with local caching) for the specified polygon, injection date, and time period\n\nCalculates the additional CO2 flux (FG_CO2_additional = FG_CO2 - FG_ALT_CO2) which represents the mCDR signal\n\nIntegrates over space and time using:\n\nArea weighting with TAREA (grid cell areas)\n\nTime weighting with days per month converted to seconds\n\nSpatial masking to restrict to points within the regional domain\n\nComputes cumulative integrals over the elapsed time dimension\n\nThe results show:\n\nTotal integrated FG_CO2: Total CO2 uptake over the entire polygon extent\n\nWithin model grid: CO2 uptake within the regional domain boundaries\n\nFraction within grid: Percentage of total uptake captured by the regional domain\n\nyears = [347+i for i in range(15)]\nyears\n\n\n\ncluster = utils.dask_cluster(**dask_cluster_kwargs)\ncluster\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n%%time\n# Integrate FG_CO2 for polygon 000 over 3 months\n# Using the alk-forcing files: 0347-01, 0347-02, 0347-03\nresults = analyzer.integrate_fg_co2_polygon(\n    polygon_id=analyzer.polygon_ids_in_bounds[-1],\n    years=years[-2:-1],\n    months=[1, 2, 3],\n)\n\nprint(\"FG_CO2 Integration Results:\")\nprint(f\"  Total integrated FG_CO2: {results['total'].values[-1]:.2e}\")\nprint(f\"  Within model grid: {results['within_grid'].values[-1]:.2e}\")\nprint(f\"  Fraction within grid: {results['fraction'].values[-1]:.2%}\")\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-6-test-integrate-co2-flux-for-a-single-polygon","position":15},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 7: Integrate CO2 Flux for All Overlapping Polygons"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-7-integrate-co2-flux-for-all-overlapping-polygons","position":16},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 7: Integrate CO2 Flux for All Overlapping Polygons"},"content":"Compute the cumulative CO2 uptake for all polygons that intersect with the regional domain. This provides a comprehensive view of how much of the global mCDR signal is captured within the finite regional domain. The results are concatenated along the polygon_id dimension, creating a dataset with dimensions (polygon_id, elapsed_time).\n\n%%time\nds = None\nif not test:\n    ds = analyzer.integrate_fg_co2_all_polygons(\n        years=years,\n    )   \nds\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-7-integrate-co2-flux-for-all-overlapping-polygons","position":17},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 8: Visualize Fraction of Uptake within Regional Domain"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-8-visualize-fraction-of-uptake-within-regional-domain","position":18},{"hierarchy":{"lvl1":"Test Tiny","lvl2":"Step 8: Visualize Fraction of Uptake within Regional Domain"},"content":"Map the fraction of CO2 uptake captured within the regional domain for each polygon. The visualization shows:\n\nRed regions: Polygons where a large fraction of CO2 uptake occurs within the regional domain\n\nBlue regions: Polygons where most CO2 uptake occurs outside the regional domain\n\nThis spatial map helps identify which mCDR injection locations are most effectively captured by the regional model domain, which is critical for understanding the efficiency of regional mCDR monitoring and modeling efforts.\n\nif ds is not None:\n    analyzer.set_field_within_boundaries(ds.fraction.isel(elapsed_time=-1)).plot(cmap=\"RdBu_r\")\n\n\n\n\n# check if LocalCluster is running and shutdown\nif cluster.local_cluster:\n    cluster.shutdown()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-test-t#step-8-visualize-fraction-of-uptake-within-regional-domain","position":19},{"hierarchy":{"lvl1":"WIO Toy"},"type":"lvl1","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to","position":0},{"hierarchy":{"lvl1":"WIO Toy"},"content":"","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to","position":1},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Mapping the Extent of mCDR Signals within Finite Regional Domains"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#mapping-the-extent-of-mcdr-signals-within-finite-regional-domains","position":2},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Mapping the Extent of mCDR Signals within Finite Regional Domains"},"content":"This notebook demonstrates how to map the extent of marine Carbon Dioxide Removal (mCDR) signals within finite regional domains. The analysis involves:\n\nDefining the regional model grid: Creating a finite regional ocean model grid using ROMS tools\n\nLoading the global atlas grid: Using the POP ocean model grid as the base for the atlas dataset\n\nIdentifying overlapping polygons: Finding which atlas polygons intersect with the regional domain\n\nIntegrating CO2 fluxes: Computing cumulative CO2 uptake within the regional domain boundaries\n\nVisualizing results: Mapping the fraction of CO2 uptake captured within the regional domain\n\nThe key challenge is determining what fraction of the global mCDR signal (from the atlas) is captured within a finite regional model domain, which is essential for understanding the efficiency and spatial extent of regional mCDR deployments.\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#mapping-the-extent-of-mcdr-signals-within-finite-regional-domains","position":3},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 1: Import Required Libraries"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-1-import-required-libraries","position":4},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 1: Import Required Libraries"},"content":"Load the necessary Python packages for data manipulation, grid handling, and analysis utilities.\n\n%load_ext autoreload\n%autoreload 2\n\nimport numpy as np\nimport xarray as xr\n\nimport roms_tools as rt\n\nimport cdr_atlas\nimport parsers\nimport utils\n\n\n\ngrid_yaml = \"tests/_grid.yml\"\ntest = True\ndask_cluster_kwargs = {\n    \"account\": \"m4632\",\n    \"queue_name\": \"premium\",\n    \"scheduler_file\": None,\n}\n\n\n\n# Parameters\ndomain_name = \"WIO Toy\"\ngrid_yaml = \"cson_forge/blueprints/cson_roms-marbl_v0.1_wio-toy/_grid.yml\"\ntest = True\ndask_cluster_kwargs = {\n    \"account\": \"m4632\",\n    \"queue_name\": \"premium\",\n    \"n_nodes\": 1,\n    \"n_tasks_per_node\": 128,\n    \"wallclock\": \"02:00:00\",\n    \"scheduler_file\": None,\n}\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-1-import-required-libraries","position":5},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 2: Define the Regional Model Grid"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-2-define-the-regional-model-grid","position":6},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 2: Define the Regional Model Grid"},"content":"Create a finite regional ocean model grid using ROMS (Regional Ocean Modeling System) tools. This grid defines the spatial boundaries of our regional domain. The grid parameters include:\n\nGrid dimensions: number of grid points\n\nPhysical size: domain extent\n\nCenter location: geographic center\n\nRotation: grid rotation angle\n\nVertical levels: number of vertical sigma levels\n\nThe grid is plotted to visualize the regional domain extent.\n\nmodel_grid = parsers.load_roms_tools_object(grid_yaml)\nmodel_grid.plot()\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-2-define-the-regional-model-grid","position":7},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 2: Load the Global Atlas Grid"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-2-load-the-global-atlas-grid","position":8},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 2: Load the Global Atlas Grid"},"content":"Load the POP (Parallel Ocean Program) global ocean model grid (POP_gx1v7), which serves as the base grid for the atlas dataset. This grid provides the spatial coordinates (TLAT, TLONG) and cell areas (TAREA) needed for area-weighted calculations.\n\natlas_grid = cdr_atlas.get_pop_grid()\natlas_grid\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-2-load-the-global-atlas-grid","position":9},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 4: Load Polygon Masks"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-4-load-polygon-masks","position":10},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 4: Load Polygon Masks"},"content":"Load the polygon masks from the atlas dataset. Each polygon represents a distinct mCDR injection location. The polygon IDs are masked to only include ocean points (where KMT > 0, indicating valid ocean grid cells).\n\nds_atlas_polygons = cdr_atlas.get_polygon_masks_dataset()\npolygon_ids = ds_atlas_polygons.polygon_id.where(atlas_grid.KMT > 0)\npolygon_ids.plot()\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-4-load-polygon-masks","position":11},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 5: Create Analyzer and Identify Overlapping Polygons"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-5-create-analyzer-and-identify-overlapping-polygons","position":12},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 5: Create Analyzer and Identify Overlapping Polygons"},"content":"Initialize the AtlasModelGridAnalyzer class, which:\n\nComputes the convex hull of the regional model grid using all lat/lon points from model_grid.ds.lat_u and lon_u\n\nPerforms point-in-polygon tests to identify which atlas grid points fall within the regional domain boundaries\n\nExtracts unique polygon IDs that have at least some overlap with the regional domain\n\nCreates a polygon ID mask where polygon IDs are set to -1 outside the regional domain\n\nThe analyzer uses a convex hull approach (rather than a simple bounding box) to accurately handle non-rectangular regional domains. The resulting mask shows which polygons intersect with the regional domain.p\n\n# Create AtlasModelGridAnalyzer instance\nanalyzer = cdr_atlas.AtlasModelGridAnalyzer(model_grid, atlas_grid, polygon_ids=polygon_ids)\n\n# Get polygon IDs within model grid boundaries\nprint(f\"Found {len(analyzer.polygon_ids_in_bounds)} unique polygon IDs within model grid boundaries\")\nprint(f\"Polygon IDs: {analyzer.polygon_ids_in_bounds[:100]}...\" if len(analyzer.polygon_ids_in_bounds) > 100 else f\"Polygon IDs: {analyzer.polygon_ids_in_bounds}\")\n\nanalyzer.polygon_id_mask.plot(vmin=-1, vmax=analyzer.polygon_id_mask.max())\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-5-create-analyzer-and-identify-overlapping-polygons","position":13},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 6: Test: Integrate CO2 Flux for a Single Polygon"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-6-test-integrate-co2-flux-for-a-single-polygon","position":14},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 6: Test: Integrate CO2 Flux for a Single Polygon"},"content":"Compute the cumulative CO2 uptake for a single polygon over a 3-month period. The integration:\n\nRetrieves alk-forcing files from S3 (with local caching) for the specified polygon, injection date, and time period\n\nCalculates the additional CO2 flux (FG_CO2_additional = FG_CO2 - FG_ALT_CO2) which represents the mCDR signal\n\nIntegrates over space and time using:\n\nArea weighting with TAREA (grid cell areas)\n\nTime weighting with days per month converted to seconds\n\nSpatial masking to restrict to points within the regional domain\n\nComputes cumulative integrals over the elapsed time dimension\n\nThe results show:\n\nTotal integrated FG_CO2: Total CO2 uptake over the entire polygon extent\n\nWithin model grid: CO2 uptake within the regional domain boundaries\n\nFraction within grid: Percentage of total uptake captured by the regional domain\n\nyears = [347+i for i in range(15)]\nyears\n\n\n\ncluster = utils.dask_cluster(**dask_cluster_kwargs)\ncluster\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n%%time\n# Integrate FG_CO2 for polygon 000 over 3 months\n# Using the alk-forcing files: 0347-01, 0347-02, 0347-03\nresults = analyzer.integrate_fg_co2_polygon(\n    polygon_id=analyzer.polygon_ids_in_bounds[-1],\n    years=years[-2:-1],\n    months=[1, 2, 3],\n)\n\nprint(\"FG_CO2 Integration Results:\")\nprint(f\"  Total integrated FG_CO2: {results['total'].values[-1]:.2e}\")\nprint(f\"  Within model grid: {results['within_grid'].values[-1]:.2e}\")\nprint(f\"  Fraction within grid: {results['fraction'].values[-1]:.2%}\")\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-6-test-integrate-co2-flux-for-a-single-polygon","position":15},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 7: Integrate CO2 Flux for All Overlapping Polygons"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-7-integrate-co2-flux-for-all-overlapping-polygons","position":16},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 7: Integrate CO2 Flux for All Overlapping Polygons"},"content":"Compute the cumulative CO2 uptake for all polygons that intersect with the regional domain. This provides a comprehensive view of how much of the global mCDR signal is captured within the finite regional domain. The results are concatenated along the polygon_id dimension, creating a dataset with dimensions (polygon_id, elapsed_time).\n\n%%time\nds = None\nif not test:\n    ds = analyzer.integrate_fg_co2_all_polygons(\n        years=years,\n    )   \nds\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-7-integrate-co2-flux-for-all-overlapping-polygons","position":17},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 8: Visualize Fraction of Uptake within Regional Domain"},"type":"lvl2","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-8-visualize-fraction-of-uptake-within-regional-domain","position":18},{"hierarchy":{"lvl1":"WIO Toy","lvl2":"Step 8: Visualize Fraction of Uptake within Regional Domain"},"content":"Map the fraction of CO2 uptake captured within the regional domain for each polygon. The visualization shows:\n\nRed regions: Polygons where a large fraction of CO2 uptake occurs within the regional domain\n\nBlue regions: Polygons where most CO2 uptake occurs outside the regional domain\n\nThis spatial map helps identify which mCDR injection locations are most effectively captured by the regional model domain, which is critical for understanding the efficiency of regional mCDR monitoring and modeling efforts.\n\nif ds is not None:\n    analyzer.set_field_within_boundaries(ds.fraction.isel(elapsed_time=-1)).plot(cmap=\"RdBu_r\")\n\n\n\n\n# check if LocalCluster is running and shutdown\nif cluster.local_cluster:\n    cluster.shutdown()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","type":"content","url":"/regional-domain-sizing-cson-roms-marbl-v0-1-wio-to#step-8-visualize-fraction-of-uptake-within-regional-domain","position":19}]}